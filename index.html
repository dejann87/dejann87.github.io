<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pay Calculator & YTD Projection</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<style>
  :root {
    --primary-color: #2c3e50; /* Midnight Navy */
    --accent-color: #3498db;  /* Bright Blue */
    --success-color: #27ae60; /* Green */
    --danger-color: #c0392b;  /* Red */
    --bg-color: #f4f7f6;
    --card-bg: #ffffff;
    --border-color: #dce1e4;
    --text-main: #2c3e50;
    --text-muted: #7f8c8d;
  }

  body { 
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    background-color: var(--bg-color); 
    padding: 30px;
    color: var(--text-main);
    display: flex;
    justify-content: center;
  }

  .container {
    background: var(--card-bg);
    width: 1100px; 
    padding: 40px;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    position: relative; 
  }

  /* VERSION TAG STYLE */
  .version-tag {
    position: absolute;
    top: 15px;
    right: 20px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-muted);
    background: #f0f2f5;
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #dce1e4;
  }

  h2 { 
    margin-top: 0; 
    color: var(--primary-color); 
    text-align: center; 
    margin-bottom: 30px; 
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 20px;
  }
  
  /* --- UPLOAD GRID SECTION --- */
  .upload-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }

  .upload-box {
    border: 3px dashed var(--border-color);
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    background: #fdfdfd;
    position: relative;
    transition: all 0.2s ease;
    min-height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .upload-box:hover, .upload-box.drag-active {
    border-color: var(--accent-color);
    background: #f0f8ff;
    transform: translateY(-2px);
  }

  .upload-icon { font-size: 42px; margin-bottom: 12px; opacity: 0.8; }
  .upload-title { font-weight: 700; color: var(--primary-color); font-size: 16px; margin-bottom: 6px; text-transform: uppercase; }
  .upload-sub { font-size: 13px; color: var(--text-muted); margin-bottom: 15px; }
  
  /* Invisible File Input covering the box */
  .file-input-full {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    opacity: 0; cursor: pointer; z-index: 10;
  }

  /* Status Badge inside box */
  .status-badge {
    margin-top: 10px;
    font-size: 12px;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 20px;
    background: #eee;
    color: #555;
    display: inline-block;
    transition: all 0.3s;
  }
  .status-success { background: #e8f8f5; color: var(--success-color); border: 1px solid #d1f2eb; }
  .status-error { background: #fdedec; color: var(--danger-color); border: 1px solid #fadbd8; }
  
  /* Dropdown inside the box needs higher z-index to be clickable */
  .person-select-container {
    position: relative;
    z-index: 20; 
    width: 80%;
    margin-top: 10px;
  }
  select {
    width: 100%; padding: 8px; border: 1px solid var(--border-color);
    border-radius: 4px; font-size: 14px; background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  /* --- 2. CONTROLS --- */
  .controls { 
    display: grid; 
    grid-template-columns: 1fr 1fr 1fr; 
    gap: 20px; 
    margin-bottom: 30px; 
    background: #fff; 
    padding: 20px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
  }
  .control-group label { 
    display: block; font-size: 12px; font-weight: 700; 
    color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; 
  }
  .control-group input, .control-group select { 
    width: 100%; padding: 10px; 
    border: 1px solid var(--border-color); border-radius: 4px; 
    box-sizing: border-box; font-size: 14px; color: var(--text-main);
    transition: border 0.2s;
  }
  .control-group input:focus, .control-group select:focus { border-color: var(--accent-color); outline: none; }
  
  .checkbox-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px;}
  .checkbox-item { font-size: 13px; color: var(--text-main); display: flex; align-items: center; cursor: pointer; }
  .checkbox-item input { margin-right: 10px; width: auto; transform: scale(1.1); }

  /* --- 3. ROSTER TABLE --- */
  .week-header { 
    background-color: var(--primary-color); 
    color: white;
    font-weight: 700; 
    padding: 10px 15px; 
    border-radius: 4px; 
    margin-top: 20px; 
    margin-bottom: 0; 
    font-size: 14px;
    letter-spacing: 0.5px;
    display: flex; justify-content: space-between;
  }

  table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 10px; border: 1px solid var(--border-color); border-top: none; }
  th { 
    text-align: left; font-size: 11px; font-weight: 700; color: var(--text-muted); 
    padding: 12px 8px; border-bottom: 1px solid var(--border-color); background: #fbfcfd; text-transform: uppercase;
  }
  td { padding: 8px; vertical-align: middle; border-bottom: 1px solid #eee; }
  tr:last-child td { border-bottom: none; }
  
  .day-label { display: flex; flex-direction: column; }
  .day-label span:first-child { font-size: 14px; font-weight: 500; }
  .ph-name-label { font-size: 10px; color: #e74c3c; font-weight: bold; text-transform: uppercase; margin-top: 2px;}

  /* Inputs inside table */
  .input-group { display: flex; gap: 5px; }
  input.time-input { 
    padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 100%; 
    font-family: monospace; font-size: 14px; text-align: center;
  }
  input.time-input:focus { border-color: var(--accent-color); outline: none; }
  
  /* Highlights */
  input.time-input.ph-highlight { background-color: #fff3cd; border-color: #ffeeba; color: #856404; }
  
  input.ext-input {
      width: 60px; padding: 8px; border: 1px solid #fadbd8; background-color: #fdedec;
      border-radius: 4px; font-family: monospace; font-size: 13px; text-align: center; color: #c0392b;
  }
  
  .ot-check, .pto-check, .ojt-check { transform: scale(1.2); cursor: pointer; accent-color: var(--primary-color); }
  .daily-total { font-weight: 700; color: var(--primary-color); padding-left: 10px; font-size: 14px; text-align: right; width: 160px; }

  /* Tags */
  .rate-tag { 
    font-size: 10px; color: #fff; padding: 3px 6px; border-radius: 3px; 
    margin-left: 5px; vertical-align: middle; display: inline-block; font-weight: 600; text-transform: uppercase;
  }
  .tag-ph { background: #e74c3c; } 
  .tag-pto { background: #16a085; } 
  .tag-off-pay { background: #95a5a6; } 
  .tag-split { background: #8e44ad; } 
  .tag-early { background: #d35400; } 
  .tag-night { background: #2c3e50; } 
  .tag-evening { background: #2980b9; } 
  .tag-load { background: #27ae60; } 
  .tag-ext { background: #c0392b; }
  .tag-ojt { background: #34495e; } 
  .tag-sick { background: #c0392b; }
  .tag-carer { background: #9b59b6; }
  .tag-edo { background: #7f8c8d; }

  /* --- 4. BUTTONS --- */
  .btn-group { display: flex; gap: 15px; margin-top: 30px; }
  
  .btn-calculate { 
    flex: 2; padding: 15px; background-color: var(--primary-color); color: white; 
    font-size: 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; 
    letter-spacing: 0.5px; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: background 0.2s, transform 0.1s;
  }
  .btn-calculate:hover { background-color: #1a252f; }
  .btn-calculate:active { transform: translateY(1px); }
  
  .btn-save { 
    flex: 1; padding: 15px; background-color: #95a5a6; color: white; 
    font-size: 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; 
    letter-spacing: 0.5px; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: background 0.2s;
  }
  .btn-save:hover { background-color: #7f8c8d; }

  .btn-reset { 
    flex: 1; padding: 15px; background-color: var(--danger-color); color: white; 
    font-size: 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; 
    letter-spacing: 0.5px; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transition: background 0.2s;
  }
  .btn-reset:hover { background-color: #a93226; }

  /* --- 5. PAYSLIP RESULT STYLE --- */
  .results-box { 
    margin-top: 40px; 
    background: #fff; 
    border: 1px solid #ccc; 
    padding: 0; 
    display: none; 
    font-family: 'Arial', sans-serif; 
    color: #000;
  }
  
  .payslip-header {
    background-color: #f0f0f0;
    padding: 12px 20px;
    border-bottom: 2px solid #333;
    display: flex;
    justify-content: space-between;
    font-weight: 700;
    font-size: 16px;
    color: #000;
  }

  .payslip-grid {
    display: grid;
    grid-template-columns: 1.2fr 1fr 0.8fr; 
    gap: 0;
  }
  
  .payslip-col {
    padding: 15px;
    border-right: 1px solid #ccc;
  }
  .payslip-col:last-child { border-right: none; }
  
  .col-title {
    font-weight: 700; 
    text-transform: uppercase;
    font-size: 12px;
    color: #000;
    border-bottom: 1px solid #000;
    display: block;
    margin-bottom: 10px;
    padding-bottom: 4px;
  }

  .ps-table { width: 100%; font-size: 11px; border-collapse: collapse; }
  .ps-table th { text-align: left; padding: 4px 0; color: #555; font-weight: normal; font-style: italic; border-bottom: 1px dashed #ddd; }
  .ps-table td { padding: 6px 0; border-bottom: 1px solid #eee; color: #000; }
  .ps-table tr:last-child td { border-bottom: none; }
  .ps-table .val-col { text-align: right; font-weight: bold; }

  .payslip-summary {
    border-top: 2px solid #000;
    padding: 20px;
    background-color: #f9f9f9;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 10px;
    text-align: center;
  }
  
  .sum-box { display: flex; flex-direction: column; border: 1px solid #ccc; background: #fff; padding: 8px; border-radius: 2px; }
  .sum-label { font-size: 10px; color: #555; font-weight: 700; margin-bottom: 4px; text-transform: uppercase; }
  .sum-val { font-size: 14px; color: #000; font-weight: 700; }
  
  .net-box { border: 2px solid #000; background: #fff; }
  .net-box .sum-val { font-size: 16px; color: #000; text-decoration: underline; }

  /* --- 6. VARIANCE REPORT --- */
  .variance-section {
    margin-top: 40px;
    border: 2px solid var(--primary-color);
    border-radius: 6px;
    background: #fff;
    overflow: hidden;
    display: none; 
  }
  .variance-header {
    background: var(--primary-color);
    color: white;
    padding: 10px 15px;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 14px;
  }
  .var-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .var-table th { background: #ecf0f1; border-bottom: 2px solid #bdc3c7; color: #2c3e50; padding: 10px; }
  .var-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: right; }
  .var-table td:first-child { text-align: left; font-weight: 600; }
  .var-match { color: var(--success-color); font-weight: bold; }
  .var-diff { color: var(--danger-color); font-weight: bold; background: #fdedec; }
  
  /* --- 7. YTD SECTION --- */
  .ytd-section { 
    border-top: 1px solid #ddd;
    background-color: #fff; 
    padding: 20px; 
    margin-top: 20px;
  }
  .ytd-header { 
    color: var(--primary-color); 
    border-bottom: 1px solid #eee; 
    padding-bottom: 10px; 
    margin-bottom: 15px; 
    font-size: 14px; 
    font-weight: 700; 
    text-transform: uppercase;
  }
  .ytd-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .ytd-input label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase;}
  .ytd-result { background: #fdfdfd; padding: 12px; border-radius: 4px; border: 1px solid #eee; }
  .ytd-res-label { font-size: 11px; color: #777; margin-bottom: 4px; text-transform: uppercase; }
  .ytd-res-value { font-size: 18px; font-weight: 700; color: var(--primary-color); }

  /* ANIMATION */
  .emoji-particle {
    position: absolute;
    font-size: 24px; pointer-events: none; user-select: none; z-index: 9999;
    animation: flyEmoji 1s ease-out forwards;
  }
  @keyframes flyEmoji {
    0% { transform: translate(0, 0) scale(0.5) rotate(0deg); opacity: 1; }
    100% { transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(var(--rot)); opacity: 0; }
  }
</style>
</head>
<body>

<div class="container" id="printableArea">
  <div class="version-tag">Version: 3.2 (Gazette Sep)</div>
  <h2>üìÖ Pay Calculator & Check</h2>

  <div class="upload-grid">
    <div class="upload-box" id="box-roster">
        <span class="upload-icon">üìÑ</span>
        <span class="upload-title">1. Roster PDF</span>
        <span class="upload-sub">Drag & drop or click to upload</span>
        
        <input type="file" id="pdfInput" accept=".pdf" class="file-input-full" onchange="handlePdfUpload()">
        
        <span id="dateStatus" class="status-badge">Waiting for file...</span>

        <div class="person-select-container">
           <select id="personSelect" onchange="populateShifts()">
              <option value="">(Upload PDF first)</option>
           </select>
        </div>
    </div>

    <div class="upload-box" id="box-payslip">
        <span class="upload-icon">üí∞</span>
        <span class="upload-title">2. Payslip PDF</span>
        <span class="upload-sub">Drag & drop or click to compare</span>
        
        <input type="file" id="payslipInput" accept=".pdf" class="file-input-full" onchange="handlePayslipUpload()">
        
        <span id="payslipStatus" class="status-badge">Waiting for file...</span>
    </div>
  </div>

  <div class="controls">
    <div class="control-group">
      <label>Fortnight Start (Sunday)</label>
      <input type="date" id="startDate" onchange="updateDates()">
    </div>
    <div class="control-group">
      <label>Hourly Rate ($)</label>
      <input type="number" id="rate" placeholder="0.00">
    </div>
    <div class="control-group">
      <label>Novated Lease (Pre-Tax)</label>
      <input type="number" id="lease" placeholder="0.00">
    </div>
    <div class="control-group">
      <label>Super Sacrifice (Pre-Tax)</label>
      <input type="number" id="superSac" placeholder="0.00">
    </div>
    <div class="control-group">
      <label>Other (Post-Tax)</label>
      <input type="number" id="postTaxOther" placeholder="0.00">
    </div>
    <div class="control-group">
      <label>Super Post-Tax</label>
      <input type="number" id="postTaxSuper" placeholder="0.00">
    </div>

    <div class="control-group" style="grid-column: 1 / -1;">
      <label>Tax Settings</label>
      <div class="checkbox-area">
        <label class="checkbox-item"><input type="checkbox" id="taxFree" checked> Tax Free Threshold</label>
        <label class="checkbox-item"><input type="checkbox" id="hecs"> HECS/HELP Debt</label>
      </div>
    </div>
  </div>

  <div class="week-header">
      <span>WEEK 1</span>
      <span style="font-weight:400; opacity:0.8;">Enter shifts below</span>
  </div>
  <table id="week1-table">
    <thead>
      <tr>
        <th style="width:130px;">Date</th>
        <th>Shift Time (Start) + Ext</th>
        <th style="text-align:center;">Man OT</th>
        <th style="text-align:center;">Bank PH</th>
        <th style="text-align:center;">OJT</th>
        <th style="text-align:right;">Calc Hrs</th>
      </tr>
    </thead>
    <tbody id="week1-body"></tbody>
  </table>

  <div class="week-header">
      <span>WEEK 2</span>
  </div>
  <table id="week2-table">
    <thead>
      <tr>
        <th style="width:130px;">Date</th>
        <th>Shift Time (Start) + Ext</th>
        <th style="text-align:center;">Man OT</th>
        <th style="text-align:center;">Bank PH</th>
        <th style="text-align:center;">OJT</th>
        <th style="text-align:right;">Calc Hrs</th>
      </tr>
    </thead>
    <tbody id="week2-body"></tbody>
  </table>

  <div class="btn-group" data-html2canvas-ignore="true">
    <button class="btn-calculate" onclick="calculatePay()">Calculate & Compare</button>
    <button class="btn-reset" onclick="resetRoster()">Reset Roster</button>
    <button class="btn-save" onclick="downloadPDF()">Save Report</button>
  </div>

  <div id="variance-report" class="variance-section">
      <div class="variance-header">‚ö†Ô∏è Payslip Variance Report</div>
      <div style="background:#ecf0f1; padding:5px 15px; font-size:11px; color:#555; border-bottom:1px solid #ccc;">
          Comparing Calculator vs. <span id="payslip-source-tag" style="font-weight:bold;">Uploaded Payslip</span>
      </div>
      <table class="var-table">
          <thead>
              <tr>
                  <th>Item</th>
                  <th>Calculated</th>
                  <th>Payslip Upload</th>
                  <th>Variance</th>
              </tr>
          </thead>
          <tbody id="variance-body">
              </tbody>
      </table>
  </div>

  <div id="results" class="results-box">
    <div class="payslip-header">
      <span>PAY ADVICE (ESTIMATED)</span>
      <span id="display-pay-period">Period Ending: --</span>
    </div>

    <div class="payslip-grid">
      <div class="payslip-col">
        <span class="col-title">Elements</span>
        <table class="ps-table">
          <thead><tr><th>Description</th><th>Units</th><th>Rate</th><th class="val-col">Value</th></tr></thead>
          <tbody id="body-elements">
            <tr id="row-base"><td>Normal</td><td id="hrs-base">0.00</td><td id="rate-base">0.00</td><td class="val-col" id="out-base">$0.00</td></tr>
            <tr id="row-ot"><td>O/T1.5 Vol</td><td id="hrs-ot">0.00</td><td id="rate-ot">0.00</td><td class="val-col" id="out-ot">$0.00</td></tr>
            <tr id="row-sat"><td>TI+50%Ros</td><td id="hrs-sat">0.00</td><td id="rate-sat">0.00</td><td class="val-col" id="out-sat">$0.00</td></tr>
            <tr id="row-sun"><td>TI+100%Ros</td><td id="hrs-sun">0.00</td><td id="rate-sun">0.00</td><td class="val-col" id="out-sun">$0.00</td></tr>
            <tr id="row-ph"><td>PHx2.5</td><td id="hrs-ph">0.00</td><td id="rate-ph">0.00</td><td class="val-col" id="out-ph">$0.00</td></tr>
            <tr id="row-ph-bank"><td>PH Worked (Bank)</td><td id="hrs-ph-bank">0.00</td><td id="rate-ph-bank">0.00</td><td class="val-col" id="out-ph-bank">$0.00</td></tr>
            <tr id="row-ph-gazette"><td>PH Gazette</td><td id="hrs-ph-gazette">0.00</td><td id="rate-ph-gazette">0.00</td><td class="val-col" id="out-ph-gazette">$0.00</td></tr>
            <tr id="row-ph-avail"><td>PH Available</td><td id="hrs-ph-avail">0.00</td><td id="rate-ph-avail">0.00</td><td class="val-col" id="out-ph-avail">$0.00</td></tr>
            <tr id="row-carer"><td>Carer's Leave</td><td id="hrs-carer">0.00</td><td id="rate-carer">0.00</td><td class="val-col" id="out-carer">$0.00</td></tr>
            <tr id="row-al-load"><td>Leave Loading 20%</td><td>-</td><td>-</td><td class="val-col" id="out-al-load">$0.00</td></tr>
          </tbody>
        </table>
      </div>

      <div class="payslip-col">
        <span class="col-title">Allowances</span>
        <table class="ps-table">
          <thead><tr><th>Description</th><th>Units</th><th>Rate</th><th class="val-col">Value</th></tr></thead>
          <tbody id="body-allowances">
            <tr id="row-ojt"><td>Fleet Control OJT</td><td id="cnt-ojt">0.00</td><td id="rate-ojt">0.00</td><td class="val-col" id="out-ojt">$0.00</td></tr>
            <tr id="row-meal"><td>Meal Allowance</td><td id="cnt-meal">0.00</td><td>14.72</td><td class="val-col" id="out-meal">$0.00</td></tr>
            <tr id="row-early"><td>Early/Aft Shift</td><td id="hrs-early">0.00</td><td>4.17</td><td class="val-col" id="out-early">$0.00</td></tr>
            <tr id="row-evening"><td>Evening Shift</td><td id="hrs-evening">0.00</td><td>4.17</td><td class="val-col" id="out-evening">$0.00</td></tr>
            <tr id="row-night"><td>Night Shift</td><td id="hrs-night">0.00</td><td>7.90</td><td class="val-col" id="out-night">$0.00</td></tr>
          </tbody>
        </table>
      </div>

      <div class="payslip-col">
        <span class="col-title">Deductions</span>
        <table class="ps-table">
          <thead><tr><th>Description</th><th class="val-col">Value</th></tr></thead>
          <tbody id="body-deductions">
            <tr id="row-lease"><td>Novated Lease</td><td class="val-col" id="r-lease">$0.00</td></tr>
            <tr id="row-superSac"><td>Super Sal Sac</td><td class="val-col" id="r-superSac">$0.00</td></tr>
            <tr id="row-otherPost"><td>Other Post-Tax</td><td class="val-col" id="r-otherPost">$0.00</td></tr>
            <tr id="row-superPost"><td>Super Post-Tax</td><td class="val-col" id="r-superPost">$0.00</td></tr>
            <tr id="row-banked" style="color:#27ae60; font-style:italic;"><td>*PH Days Banked</td><td class="val-col" id="r-banked">0.0</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="payslip-summary">
      <div class="sum-box">
        <span class="sum-label">GROSS PAY</span>
        <span class="sum-val" id="r-gross">$0.00</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">TAXABLE</span>
        <span class="sum-val" id="r-taxable">$0.00</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">PAYG TAX</span>
        <span class="sum-val" id="r-tax">$0.00</span>
      </div>
       <div class="sum-box">
        <span class="sum-label">HECS/HELP</span>
        <span class="sum-val" id="r-hecs">$0.00</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">SUPER (12%)</span>
        <span class="sum-val" id="r-super">$0.00</span>
      </div>
      <div class="sum-box net-box">
        <span class="sum-label">NET PAY</span>
        <span class="sum-val" id="r-net">$0.00</span>
      </div>
    </div>
    
    <div class="ytd-section">
       <div class="ytd-header">Year To Date (Reads from Payslip)</div>
       <div class="ytd-grid">
        <div class="ytd-input">
          <label>YTD Date (Pay Date)</label>
          <input type="date" id="ytdDate" onchange="updateYTD()">
        </div>
        <div class="ytd-input">
          <label>Current YTD Gross ($)</label>
          <input type="number" id="ytdInput" placeholder="Enter amount..." oninput="updateYTD()">
        </div>
        <div class="ytd-result">
           <span class="ytd-res-label">Avg/Fortnight</span>
           <span class="ytd-res-value" id="ytd-avg-pay">$0.00</span>
        </div>
        <div class="ytd-result">
          <span class="ytd-res-label">Fortnights Remaining</span>
          <span class="ytd-res-value" id="ytd-pays-left">0</span>
        </div>
        <div class="ytd-result" style="grid-column: 1 / -1; border-color: var(--primary-color);">
          <span class="ytd-res-label" style="color:var(--primary-color);">Projected Annual Gross</span>
          <span class="ytd-res-value" id="ytd-projected-total" style="font-size: 24px;">$0.00</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ==========================================
//  VIC PUBLIC HOLIDAYS 2025/2026
// ==========================================
const vicPublicHolidays = {
  "2025-01-01": "New Year's Day",
  "2025-01-27": "Australia Day",
  "2025-03-10": "Labour Day",
  "2025-04-18": "Good Friday",
  "2025-04-19": "Sat before Easter",
  "2025-04-20": "Easter Sunday",
  "2025-04-21": "Easter Monday",
  "2025-04-25": "ANZAC Day",
  "2025-06-09": "King's Birthday",
  "2025-09-26": "AFL Grand Final",
  "2025-11-04": "Melbourne Cup",
  "2025-12-25": "Christmas Day",
  "2025-12-26": "Boxing Day",
  "2026-01-01": "New Year's Day",
  "2026-01-26": "Australia Day",
  "2026-03-09": "Labour Day",
  "2026-04-03": "Good Friday",
  "2026-04-04": "Sat before Easter",
  "2026-04-05": "Easter Sunday",
  "2026-04-06": "Easter Monday",
  "2026-04-25": "ANZAC Day",
  "2026-06-08": "King's Birthday",
  "2026-09-25": "AFL Grand Final (Est)",
  "2026-11-03": "Melbourne Cup",
  "2026-12-25": "Christmas Day",
  "2026-12-26": "Boxing Day",
  "2026-12-28": "Boxing Day (Addl)"
};

// ==========================================
//  PDF PARSER (Roster)
// ==========================================
function downloadPDF() {
    const element = document.getElementById('printableArea');
    const dateVal = document.getElementById('startDate').value || 'date';
    const opt = { 
      margin:       10, 
      filename:     `Pay_Report_${dateVal}.pdf`, 
      image:        { type: 'jpeg', quality: 0.98 }, 
      html2canvas:  { scale: 2, useCORS: true, scrollY: 0 }, 
      jsPDF:        { unit: 'px', format: [1180, 1600], orientation: 'portrait' } 
    };
    html2pdf().set(opt).from(element).save();
}

function resetRoster() {
    document.querySelectorAll('.time-input').forEach(el => el.value = '');
    document.querySelectorAll('.ext-input').forEach(el => el.value = '');
    document.querySelectorAll('.ot-check, .pto-check, .ojt-check').forEach(el => el.checked = false);
    updateDates();
    document.getElementById('results').style.display = 'none';
    document.getElementById('variance-report').style.display = 'none';
}

let globalPdfItems = []; let detectedNames = []; 

async function handlePdfUpload() {
  const fileInput = document.getElementById('pdfInput');
  const file = fileInput.files[0];
  const statusSpan = document.getElementById('dateStatus');
  
  if (!file) return;
  statusSpan.innerText = "Scanning...";
  statusSpan.className = "status-badge"; // Reset class

  const reader = new FileReader();
  reader.onload = async function() {
    const typedarray = new Uint8Array(this.result);
    try {
      const pdf = await pdfjsLib.getDocument(typedarray).promise;
      globalPdfItems = []; let fullTextString = "";
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        textContent.items.forEach(item => { if (item.str.trim().length > 0) { globalPdfItems.push({ str: item.str, x: item.transform[4], y: item.transform[5], page: i }); fullTextString += item.str + " "; } });
      }
      globalPdfItems.sort((a,b) => { if (a.page !== b.page) return a.page - b.page; if (Math.abs(a.y - b.y) > 5) return b.y - a.y; return a.x - b.x; });
      findPersons(); detectStartDate(fullTextString); 
    } catch (e) { 
        console.error(e); 
        statusSpan.innerText = "Error"; 
        statusSpan.classList.add("status-error");
        alert('Error parsing PDF.'); 
    }
  };
  reader.readAsArrayBuffer(file);
}

function detectStartDate(text) {
  const statusSpan = document.getElementById('dateStatus');
  const anchorRegex = /Period\s*Start\s*[:\-\s]*([0-9A-Za-z\/\-\.\s]+)/i;
  const anchorMatch = text.match(anchorRegex);
  let rawDateText = anchorMatch && anchorMatch[1] ? anchorMatch[1].substring(0, 20) : text;
  const datePatterns = [ /\b(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\b/, /\b(\d{1,2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+(\d{4})\b/i ];
  let foundDate = null;
  for (let pat of datePatterns) {
      const m = rawDateText.match(pat);
      if (m) {
          let d = parseInt(m[1]), y = parseInt(m[3]), mo = -1;
          if (m[2].match(/[a-z]/i)) { const months = ["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"]; mo = months.indexOf(m[2].toLowerCase().substring(0,3)); } else { mo = parseInt(m[2]) - 1; }
          if (y > 2020 && mo >= 0 && d > 0 && d <= 31) { foundDate = new Date(y, mo, d); break; }
      }
  }
  if (foundDate) {
      const dayOfWeek = foundDate.getDay(); if (dayOfWeek !== 0) foundDate.setDate(foundDate.getDate() - dayOfWeek);
      const yyyy = foundDate.getFullYear(), mm = String(foundDate.getMonth() + 1).padStart(2, '0'), dd = String(foundDate.getDate()).padStart(2, '0');
      document.getElementById('startDate').value = `${yyyy}-${mm}-${dd}`;
      statusSpan.innerText = "‚úì " + `${yyyy}-${mm}-${dd}`;
      statusSpan.classList.add("status-success");
      updateDates(); 
  } else { 
      statusSpan.innerText = "Date not found"; 
      statusSpan.classList.add("status-error");
  }
}

function findPersons() {
  const ignore = [
    'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday', 
    'Start', 'Finish', 'Date', 'Time', 'Roster', 'Employee', 'Total', 'Hours', 
    'Shift', 'Break', 'Week', 'Ending', 'Period', 'Page', 'Printed', 'Fortnight', 
    'Code', 'Name', 'Pos', 'Foll', 'Farmer', 'Work', 'Calendar', 'Raport',
    'Allowance', 'Call', 'On', 'Hastus', 'Paid'
  ];
  const nameRegex = /^[A-Z][a-zA-Z'\-]+(?:\s+[A-Z][a-zA-Z'\-]+){1,2}$/;
  detectedNames = []; const uniqueNamesSet = new Set();
  globalPdfItems.forEach(item => {
      const str = item.str.trim();
      if (item.x > 120) return;
      if (str.includes('HASTUS') || str.includes('ewcr01')) return;
      if(nameRegex.test(str)) { 
          const parts = str.split(/\s+/);
          const isIgnored = parts.some(part => ignore.includes(part));
          if (!isIgnored) { 
              const cleanName = parts.join(' ');
              if(!uniqueNamesSet.has(cleanName)) { uniqueNamesSet.add(cleanName); detectedNames.push({ name: cleanName, page: item.page, y: item.y }); } 
          } 
      }
  });
  const select = document.getElementById('personSelect'); 
  select.innerHTML = '<option value="">-- Select Person --</option>';
  [...detectedNames].sort((a,b) => a.name.localeCompare(b.name)).forEach(obj => { const opt = document.createElement('option'); opt.value = obj.name; opt.innerText = obj.name; select.appendChild(opt); });
}

function populateShifts() {
  const selectedName = document.getElementById('personSelect').value; if (!selectedName) return;
  resetRoster(); 
  const personIndex = detectedNames.findIndex(p => p.name === selectedName); if (personIndex === -1) return;
  const currentPerson = detectedNames[personIndex];
  const topY = currentPerson.y + 5; 
  let bottomY = 0; 
  if (personIndex + 1 < detectedNames.length) { const nextPerson = detectedNames[personIndex + 1]; if (nextPerson.page === currentPerson.page) bottomY = nextPerson.y + 5; }
  
  const zoneItems = globalPdfItems.filter(item => {
      if (item.page !== currentPerson.page) return false;
      if (item.y > topY) return false;
      if (bottomY > 0 && item.y <= bottomY) return false;
      if (item.str.includes('HASTUS') || item.str.includes('ewcr01')) return false;
      return true;
  });
  
  zoneItems.sort((a,b) => a.x - b.x);
  let zoneString = zoneItems.map(i => i.str).join('  ').replace(/OJT\s+(\d{4}|\d{1,2}:\d{2})/gi, " ");
  
  const rawTokens = zoneString.match(/([0-1]?[0-9]|2[0-3]):([0-5][0-9])|\bOFF\b|\bPAID\b|\bAL\b|\bPHDO\b|\bEXTRA\b|\bCARER\b|\bCARERS\b/gi);
  if (!rawTokens) { alert("No valid times found."); return; }

  const tokens = rawTokens.filter(t => {
      if (t.includes(':')) { const parts = t.split(':'); const mins = parseInt(parts[1], 10); return (mins % 15 === 0); }
      return true;
  });

  let tokenIndex = 0;
  for(let w=1; w<=2; w++) { for(let d=0; d<7; d++) {
        if (tokenIndex >= tokens.length) break;
        const uniqueId = `w${w}_d${d}`, input = document.getElementById(`${uniqueId}_start`);
        let val = tokens[tokenIndex].toUpperCase();
        val = val.replace(/\s+/, ' ');
        
        if (val === 'OFF') { input.value = "OFF"; tokenIndex++; if (tokenIndex < tokens.length && tokens[tokenIndex].toUpperCase() === 'OFF') tokenIndex++; }
        else if (val === 'PAID') {
            if (tokenIndex + 1 < tokens.length && tokens[tokenIndex+1].toUpperCase() === 'AL') { input.value = "PAID AL"; tokenIndex += 2; } 
            else { input.value = "PAID AL"; tokenIndex++; }
        }
        else if (val === 'AL') { 
            input.value = "PAID AL"; tokenIndex++; 
            if (tokenIndex < tokens.length) { const nextVal = tokens[tokenIndex].toUpperCase(); if (nextVal === 'AL') tokenIndex++; }
        }
        else if (val === 'PHDO') { 
            input.value = "PHDO"; tokenIndex++; 
            if (tokenIndex < tokens.length && tokens[tokenIndex].toUpperCase() === 'PHDO') tokenIndex++; 
        }
        else if (val === 'EXTRA') { tokenIndex++; }
        else if (val === 'CARER' || val === 'CARERS') {
            input.value = "CARER"; tokenIndex++;
        }
        else { 
            input.value = tokens[tokenIndex]; tokenIndex++; 
            if (tokenIndex < tokens.length) { const nextVal = tokens[tokenIndex].toUpperCase(); if (nextVal.includes(':')) tokenIndex++; } 
        }
        if (tokenIndex < tokens.length && tokens[tokenIndex].toUpperCase() === 'EXTRA') {
            document.getElementById(`${uniqueId}_forceOT`).checked = true; tokenIndex++; 
        }
        calcRow(uniqueId);
  }}
}

// ==========================================
//  PAYSLIP PARSER (Updated for Multiple Docs & YTD)
// ==========================================
let importedPayslipData = null;

async function handlePayslipUpload() {
    const fileInput = document.getElementById('payslipInput');
    const file = fileInput.files[0];
    const statusSpan = document.getElementById('payslipStatus');
    if (!file) return;

    statusSpan.innerText = "Scanning...";
    statusSpan.className = "status-badge";

    const reader = new FileReader();
    reader.onload = async function() {
        try {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            
            // 1. Extract all text items, sorted
            let allItems = [];
            let fullPdfText = ""; // RAW TEXT FOR NAME MATCHING
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                textContent.items.forEach(item => { 
                    if (item.str.trim().length > 0) { 
                        allItems.push({ str: item.str.trim(), x: item.transform[4], y: item.transform[5], page: i }); 
                        fullPdfText += item.str + " ";
                    } 
                });
            }
            // Sort: Page -> Y (desc) -> X (asc)
            allItems.sort((a,b) => { 
                if (a.page !== b.page) return a.page - b.page; 
                if (Math.abs(a.y - b.y) > 2) return b.y - a.y; 
                return a.x - b.x; 
            });

            // 2. Identify "Pay Advice" chunks
            let documents = [];
            let currentDoc = [];
            
            for (let item of allItems) {
                if (item.str === "PayAdvice" && item.y > 500) {
                    if (currentDoc.length > 50) { 
                         documents.push(currentDoc);
                         currentDoc = [];
                    }
                }
                currentDoc.push(item);
            }
            if (currentDoc.length > 0) documents.push(currentDoc);

            // 3. Process each document and find the "Main" one (Highest Gross)
            let bestDocData = null;
            let maxGross = -1;

            documents.forEach((docItems, index) => {
                const data = parsePayslipDocument(docItems);
                if (data.gross > maxGross) {
                    maxGross = data.gross;
                    bestDocData = data;
                }
            });

            if (bestDocData) {
                importedPayslipData = bestDocData;
                statusSpan.innerText = `‚úì Loaded ($${bestDocData.gross.toFixed(2)})`;
                statusSpan.classList.add("status-success");
                
                // --- AUTO FILL YTD ---
                if (bestDocData.ytdGross > 0) {
                    document.getElementById('ytdInput').value = bestDocData.ytdGross.toFixed(2);
                }
                
                // --- AUTO FILL DATE ---
                if (bestDocData.payDate) {
                    document.getElementById('ytdDate').value = bestDocData.payDate;
                }
                
                // Update projections
                updateYTD();
                
                // Update hourly rate if found
                if (bestDocData.hourlyRate > 0) {
                     document.getElementById('rate').value = bestDocData.hourlyRate.toFixed(4);
                }

                // --- ROBUST AUTO MATCH NAME ---
                if (detectedNames.length > 0) {
                    let matchedName = null;
                    const cleanPdfText = fullPdfText.toLowerCase().replace(/,/g, ' ').replace(/\s+/g, ' ');
                    
                    for (let person of detectedNames) {
                        const originalName = person.name; // e.g. "John Smith"
                        const parts = originalName.trim().split(/\s+/); // ["John", "Smith"]
                        
                        let variations = [];
                        variations.push(originalName.toLowerCase()); // "john smith"
                        
                        if (parts.length >= 2) {
                            const first = parts[0].toLowerCase();
                            const last = parts[parts.length - 1].toLowerCase();
                            
                            variations.push(`${last} ${first}`); // "smith john"
                            variations.push(`${last}, ${first}`); // "smith, john"
                            variations.push(`${first} ${last}`); // "john smith"
                        }
                        
                        // Check if ANY variation exists in the PDF text
                        for (let v of variations) {
                            if (cleanPdfText.includes(v)) {
                                matchedName = originalName;
                                break;
                            }
                        }
                        if(matchedName) break;
                    }
                    
                    if (matchedName) {
                        const sel = document.getElementById('personSelect');
                        if (sel) {
                            sel.value = matchedName;
                            populateShifts(); // Trigger roster update
                            statusSpan.innerText += ` ‚Ä¢ Matched: ${matchedName}`;
                        }
                    }
                }
                
            } else {
                statusSpan.innerText = "No Data Found";
                statusSpan.classList.add("status-error");
            }

        } catch (e) {
            console.error(e);
            statusSpan.innerText = "Error";
            statusSpan.classList.add("status-error");
            alert("Error parsing Payslip PDF.");
        }
    };
    reader.readAsArrayBuffer(file);
}

function parsePayslipDocument(items) {
    let result = {
        gross: 0, tax: 0, net: 0, super: 0, hourlyRate: 0,
        ytdGross: 0, payDate: null,
        elements: {}, 
        allowances: {}
    };
    
    let captureMode = null; 
    let fullText = items.map(i => i.str).join(" ");
    
    // 1. Pay Date Extraction
    const dateMatch = fullText.match(/Pay Date\s+(\d{2}\/\d{2}\/\d{4})/);
    if (dateMatch) {
        const parts = dateMatch[1].split('/');
        result.payDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    // 2. YTD Extraction
    let ytdGrossFound = false;
    for (let i = 0; i < items.length; i++) {
        if (items[i].str.includes("YTD Gross")) {
            for (let j = i + 1; j < Math.min(i + 20, items.length); j++) {
                 const clean = items[j].str.replace(/,/g, '');
                 if (clean.match(/^[0-9]+\.[0-9]{2}$/)) {
                     const val = parseFloat(clean);
                     if (val > result.ytdGross) result.ytdGross = val;
                 }
            }
        }
    }
    
    if (result.ytdGross === 0) {
         const ytdRegex = /YTD Gross.*?(\d{2,6}\.\d{2})/;
         const m = fullText.match(ytdRegex);
         if (m) result.ytdGross = parseFloat(m[1]);
    }

    // 3. Current Pay Totals (Summary)
    const summaryRegex = /(\d{3,5}\.\d{2})\s+(\d{3,5}\.\d{2})\s+(\.\d{2}|0\.00)\s+(\.\d{2}|0\.00)\s+(\d{3,5}\.\d{2})\s+(\d{3,5}\.\d{2})/;
    const sumMatch = fullText.match(summaryRegex);
    if (sumMatch) {
        result.gross = parseFloat(sumMatch[1]);
        result.tax = parseFloat(sumMatch[5]);
        result.net = parseFloat(sumMatch[6]);
    } else {
        const grossMatch = fullText.match(/Gross\s+([0-9]+\.[0-9]{2})/);
        if(grossMatch) result.gross = parseFloat(grossMatch[1]);
    }
    
    const rateMatch = fullText.match(/Hourly Rate\s+([0-9\.]+)/);
    if(rateMatch) result.hourlyRate = parseFloat(rateMatch[1]);

    // 4. Line Items
    for (let i = 0; i < items.length; i++) {
        const txt = items[i].str;
        const lowTxt = txt.toLowerCase();

        if (lowTxt.includes("summary of earnings")) { captureMode = 'summary'; continue; }
        if ((lowTxt === "elements" || lowTxt === "description") && captureMode !== 'allowances') { captureMode = 'elements'; }
        if (lowTxt === "allowances") { captureMode = 'allowances'; continue; }
        if (lowTxt === "deductions") { captureMode = 'deductions'; continue; }
        if (lowTxt === "pay disbursement details") { captureMode = null; continue; }

        if (captureMode === 'elements' || captureMode === 'allowances') {
            const isDesc = (
                txt.includes("Normal") || txt.includes("TI+") || txt.includes("PH") || 
                txt.includes("Shift") || txt.includes("Meal") || txt.includes("OJT") ||
                txt.includes("Leave") || txt.includes("Lve") || txt.includes("Cares") || 
                txt.includes("Personal") || txt.includes("Sick") || txt.includes("Carer") ||
                txt.includes("Gazette")
            );

            if (isDesc) {
                let key = txt;
                let rowVals = [];
                for (let j = i + 1; j < items.length; j++) {
                    if (items[j].page !== items[i].page) break;
                    if (Math.abs(items[j].y - items[i].y) > 5) break; 
                    
                    let cleanStr = items[j].str.replace(/,/g,'');
                    if (cleanStr.match(/^-?[0-9]+\.?[0-9]*$/)) {
                        rowVals.push(parseFloat(cleanStr));
                    }
                }
                
                if (rowVals.length > 0) {
                    const value = rowVals[rowVals.length - 1];
                    let units = 0;
                    if (rowVals.length >= 2) units = rowVals[0]; 
                    
                    if (!result.elements[key]) result.elements[key] = { units: 0, value: 0 };
                    result.elements[key].units += units;
                    result.elements[key].value += value;
                }
            }
        }
    }
    return result;
}

// ==========================================
//  CALCULATOR & COMPARISON
// ==========================================

function clearTableInputs() { resetRoster(); }

window.onload = function() {
  generateRows('week1-body', 1); generateRows('week2-body', 2);
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('startDate').value = today;
  updateDates();
};

function generateRows(elementId, weekNum) {
  const tbody = document.getElementById(elementId);
  let html = '';
  for(let i=0; i<7; i++) {
    const uniqueId = `w${weekNum}_d${i}`;
    html += `<tr id="${uniqueId}_row"><td class="day-label" id="${uniqueId}_label"><span id="${uniqueId}_dateTxt">Day ${i+1}</span><span id="${uniqueId}_phName" class="ph-name-label"></span></td><td><div class="input-group"><input type="text" class="time-input" id="${uniqueId}_start" placeholder="Start" onblur="formatTime(this)" onchange="calcRow('${uniqueId}')"><input type="number" class="ext-input" id="${uniqueId}_ext" placeholder="+Ext" step="0.5" onchange="calcRow('${uniqueId}')"></div></td><td style="text-align:center;"><input type="checkbox" class="ot-check" id="${uniqueId}_forceOT" onchange="calcRow('${uniqueId}');"></td><td style="text-align:center;"><input type="checkbox" class="pto-check" id="${uniqueId}_pto" disabled onchange="calcRow('${uniqueId}'); bangHoliday(this)"></td><td style="text-align:center;"><input type="checkbox" class="ojt-check" id="${uniqueId}_ojt" onchange="calcRow('${uniqueId}');"></td><td class="daily-total" id="${uniqueId}_total">0.0</td><input type="hidden" id="${uniqueId}_dayIndex" value="${i}"><input type="hidden" id="${uniqueId}_fullDate" value=""><input type="hidden" id="${uniqueId}_isPH" value="false"></tr>`;
  }
  tbody.innerHTML = html;
}

function updateDates() {
  const startVal = document.getElementById('startDate').value; if(!startVal) return;
  const startDate = new Date(startVal);
  for(let w=1; w<=2; w++) {
    for(let d=0; d<7; d++) {
      const uniqueId = `w${w}_d${d}`;
      const currentDay = new Date(startDate);
      currentDay.setDate(startDate.getDate() + ((w === 1) ? d : 7 + d));
      const dayIndex = currentDay.getDay(); 
      const options = { weekday: 'short', day: 'numeric', month: 'numeric' };
      const dateStr = currentDay.toLocaleDateString('en-AU', options);
      const yyyy = currentDay.getFullYear(), mm = String(currentDay.getMonth() + 1).padStart(2, '0'), dd = String(currentDay.getDate()).padStart(2, '0');
      const isoDate = `${yyyy}-${mm}-${dd}`;
      document.getElementById(`${uniqueId}_dateTxt`).innerText = dateStr;
      document.getElementById(`${uniqueId}_dayIndex`).value = dayIndex;
      document.getElementById(`${uniqueId}_fullDate`).value = isoDate;
      const phNameLabel = document.getElementById(`${uniqueId}_phName`);
      const ptoCheckbox = document.getElementById(`${uniqueId}_pto`);
      const startInput = document.getElementById(`${uniqueId}_start`);
      const isPHHidden = document.getElementById(`${uniqueId}_isPH`);
      if (vicPublicHolidays[isoDate]) { phNameLabel.innerText = vicPublicHolidays[isoDate]; startInput.classList.add('ph-highlight'); ptoCheckbox.disabled = false; isPHHidden.value = "true"; } else { phNameLabel.innerText = ""; startInput.classList.remove('ph-highlight'); ptoCheckbox.disabled = true; ptoCheckbox.checked = false; isPHHidden.value = "false"; }
      const labelCell = document.getElementById(`${uniqueId}_dateTxt`);
      if(dayIndex === 0 || dayIndex === 6) { labelCell.style.color = "#c0392b"; labelCell.style.fontWeight = "bold"; } else { labelCell.style.color = "#2c3e50"; labelCell.style.fontWeight = "500"; }
      calcRow(uniqueId);
    }
  }
}

function formatTime(input) {
  let val = input.value.trim().toUpperCase();
  // Added CARER and CARERS to the exclusion list
  if (val === 'OFF' || val === 'AL' || val === 'PAID AL' || val === 'PHDO' || val === 'SICK' || val === 'EDO' || val === 'CARER' || val === 'CARERS') return; 
  if(val.length === 4 && !val.includes(':') && !isNaN(val)) input.value = val.substring(0,2) + ':' + val.substring(2,4);
  calcRow(input.id.split('_')[0] + '_' + input.id.split('_')[1]);
}

function parseMinutes(timeStr) {
  if(!timeStr || !timeStr.includes(':')) return null;
  const parts = timeStr.split(':');
  const h = parseInt(parts[0], 10), m = parseInt(parts[1], 10);
  if(isNaN(h) || isNaN(m)) return null;
  return (h * 60) + m;
}

function calcRow(id) {
  const startStr = document.getElementById(`${id}_start`).value.trim().toUpperCase();
  const extStr = document.getElementById(`${id}_ext`).value;
  const totalDiv = document.getElementById(`${id}_total`);
  const isPH = document.getElementById(`${id}_isPH`).value === "true";
  const isPTO = document.getElementById(`${id}_pto`).checked;
  const isForceOT = document.getElementById(`${id}_forceOT`).checked;
  const isOJT = document.getElementById(`${id}_ojt`).checked;
  const dayIndex = parseInt(document.getElementById(`${id}_dayIndex`).value);
  const fullDate = document.getElementById(`${id}_fullDate`).value;
  
  const STANDARD_SHIFT = 9.5;

  totalDiv.innerHTML = "";
  const extVal = parseFloat(extStr) || 0;

  if (isOJT) { const tag = document.createElement('span'); tag.className = "rate-tag tag-ojt"; tag.innerText = "OJT"; totalDiv.appendChild(tag); totalDiv.appendChild(document.createTextNode(" ")); }
  if (startStr === 'SICK') { const spanVal = document.createElement('span'); spanVal.innerText = STANDARD_SHIFT.toFixed(1); totalDiv.appendChild(spanVal); const tag = document.createElement('span'); tag.className = "rate-tag tag-sick"; tag.innerText = "Sick Leave"; totalDiv.appendChild(tag); return; }
  
  // LOGIC FOR CARERS LEAVE
  if (startStr === 'CARER' || startStr === 'CARERS') { 
      const spanVal = document.createElement('span'); 
      spanVal.innerText = STANDARD_SHIFT.toFixed(1); 
      totalDiv.appendChild(spanVal); 
      const tag = document.createElement('span'); 
      tag.className = "rate-tag tag-carer"; 
      tag.innerText = "Carer's Leave"; 
      totalDiv.appendChild(tag); 
      return; 
  }

  if ((startStr === 'OFF' || startStr === '') && isPH) { const spanVal = document.createElement('span'); spanVal.innerText = "8.0"; totalDiv.appendChild(spanVal); const tag = document.createElement('span'); tag.className = "rate-tag tag-off-pay"; tag.innerText = "PH Paid Not Worked"; totalDiv.appendChild(tag); return; }
  if (startStr === 'OFF' || startStr === '') { totalDiv.appendChild(document.createTextNode("0.0")); return; }
  if (startStr === 'PAID AL' || startStr === 'AL') { 
      if (dayIndex >= 1 && dayIndex <= 4) { const spanVal = document.createElement('span'); spanVal.innerText = STANDARD_SHIFT.toFixed(1); totalDiv.appendChild(spanVal); const tag = document.createElement('span'); tag.className = "rate-tag tag-load"; tag.innerText = "+20%"; totalDiv.appendChild(tag); } 
      else { const spanVal = document.createElement('span'); spanVal.innerText = "0.0"; totalDiv.appendChild(spanVal); const tag = document.createElement('span'); tag.className = "rate-tag tag-off-pay"; tag.innerText = "Unpaid AL (Fri/Wknd)"; totalDiv.appendChild(tag); }
      return; 
  }
  
  if (startStr === 'PHDO') { 
      const spanVal = document.createElement('span'); 
      spanVal.innerText = STANDARD_SHIFT.toFixed(1); 
      totalDiv.appendChild(spanVal); 
      const tag = document.createElement('span'); tag.className = "rate-tag tag-off-pay"; tag.innerText = "PH Gazette"; totalDiv.appendChild(tag);
      return; 
  }

  const startMins = parseMinutes(startStr);
  if (startMins === null) { totalDiv.appendChild(document.createTextNode("0.0")); return; }
  
  let baseDisplay = STANDARD_SHIFT;
  const spanVal = document.createElement('span'); 
  spanVal.innerText = (baseDisplay + extVal).toFixed(1); 
  totalDiv.appendChild(spanVal);
  
  if (extVal > 0) { const tag = document.createElement('span'); tag.className = "rate-tag tag-ext"; tag.innerText = "Includes OT"; totalDiv.appendChild(tag); }

  if (!isForceOT) {
      const isWeekday = (dayIndex >= 1 && dayIndex <= 5);
      const isNotPH = !vicPublicHolidays[fullDate];
      if (startMins < 360 && isWeekday && isNotPH) { const tag = document.createElement('span'); tag.className = "rate-tag tag-early"; tag.innerText = "Early"; totalDiv.appendChild(tag); }
      const shiftLenMins = STANDARD_SHIFT * 60;
      const endMins = startMins + shiftLenMins;
      let isNight = false;
      if (endMins > 1440) { isNight = true; if(isWeekday && isNotPH) { const tag = document.createElement('span'); tag.className = "rate-tag tag-night"; tag.innerText = "Night"; totalDiv.appendChild(tag); } }
      if (!isNight && endMins > 1110 && isWeekday && isNotPH) { const tag = document.createElement('span'); tag.className = "rate-tag tag-evening"; tag.innerText = "Evening"; totalDiv.appendChild(tag); }
  } else { const tag = document.createElement('span'); tag.className = "rate-tag tag-split"; tag.innerText = "Manual OT"; totalDiv.appendChild(tag); }

  if(isPH) { const tag = document.createElement('span'); if(isPTO) { tag.className = "rate-tag tag-pto"; tag.innerText = "1.5x + Bank"; } else { tag.className = "rate-tag tag-ph"; tag.innerText = "2.5x Rates"; } totalDiv.appendChild(tag); }
}

function getMultiplierForDay(isoDate, dayIndex, isForceOT, isPTO) {
    if (vicPublicHolidays[isoDate]) { if (isPTO) return { mult: 1.5, bucket: 'ph_bank', isPH: true, bank: true }; return { mult: 2.5, bucket: 'ph', isPH: true, bank: false }; }
    if (dayIndex === 0) return { mult: 2.0, bucket: 'sun', isPH: false, bank: false }; 
    if (dayIndex === 6) return { mult: (isForceOT ? 2.0 : 1.5), bucket: 'sat', isPH: false, bank: false }; 
    if (isForceOT) return { mult: 1.5, bucket: 'ot', isPH: false, bank: false }; 
    return { mult: 1.0, bucket: 'base', isPH: false, bank: false }; 
}

function getHecsRate(annualGross) {
    if (annualGross < 51550) return 0;
    if (annualGross <= 59518) return 0.01;
    if (annualGross <= 63089) return 0.02;
    if (annualGross <= 66875) return 0.025;
    if (annualGross <= 70888) return 0.03;
    if (annualGross <= 75140) return 0.035;
    if (annualGross <= 79649) return 0.04;
    if (annualGross <= 84429) return 0.045;
    if (annualGross <= 89494) return 0.05;
    if (annualGross <= 94865) return 0.055;
    if (annualGross <= 100557) return 0.06;
    if (annualGross <= 106590) return 0.065;
    if (annualGross <= 112985) return 0.07;
    if (annualGross <= 119764) return 0.075;
    if (annualGross <= 126950) return 0.08;
    if (annualGross <= 134568) return 0.085;
    if (annualGross <= 142642) return 0.09;
    if (annualGross <= 151200) return 0.095;
    return 0.10;
}

function calculatePay() {
  try {
      const rate = parseFloat(document.getElementById('rate').value) || 0;
      const lease = parseFloat(document.getElementById('lease').value) || 0;
      const superSac = parseFloat(document.getElementById('superSac').value) || 0;
      const postTaxOther = parseFloat(document.getElementById('postTaxOther').value) || 0;
      const postTaxSuper = parseFloat(document.getElementById('postTaxSuper').value) || 0;
      const claimThreshold = document.getElementById('taxFree').checked;
      const hasHecs = document.getElementById('hecs').checked;
      
      const STANDARD_HOURS = 9.5;
      const OJT_RATE = 95.04;
      const MEAL_ALLOWANCE_RATE = 14.72;

      let buckets = { 
          base: { hours: 0, pay: 0 }, 
          ot: { hours: 0, pay: 0 }, 
          sat: { hours: 0, pay: 0 }, 
          sun: { hours: 0, pay: 0 }, 
          ph: { hours: 0, pay: 0 }, 
          ph_bank: { hours: 0, pay: 0 },
          ph_gazette: { hours: 0, pay: 0 },
          ph_available: { hours: 0, pay: 0 }
      };

      let earlyShiftPay = 0; let earlyShiftHoursPaid = 0;
      let eveningShiftPay = 0; let eveningShiftHoursPaid = 0;
      let nightShiftPay = 0; let nightShiftHoursPaid = 0;
      let alLoadingPay = 0; let bankedDays = 0;
      let ojtCount = 0;
      let mealAllowanceCount = 0; 
      
      // NEW VARIABLES FOR CARERS LEAVE
      let carerHours = 0;
      let carerPay = 0;

      let hasActiveShifts = false;

      const SHIFT_DURATION_MINS = STANDARD_HOURS * 60; 
      
      for (let w = 1; w <= 2; w++) {
        for (let d = 0; d < 7; d++) {
          const uniqueId = `w${w}_d${d}`;
          const startStr = document.getElementById(`${uniqueId}_start`).value.toUpperCase();
          const extVal = parseFloat(document.getElementById(`${uniqueId}_ext`).value) || 0; 
          const dayIndex = parseInt(document.getElementById(`${uniqueId}_dayIndex`).value);
          const fullDate = document.getElementById(`${uniqueId}_fullDate`).value; 
          const isForceOT = document.getElementById(`${uniqueId}_forceOT`).checked;
          const isOJT = document.getElementById(`${uniqueId}_ojt`).checked;
          const isPH_Start = document.getElementById(`${uniqueId}_isPH`).value === "true";
          const isPTO = document.getElementById(`${uniqueId}_pto`).checked;
          
          if (startStr !== '' && startStr !== 'OFF') hasActiveShifts = true;
          
          if (isOJT) ojtCount++;
          if (extVal > 0) { buckets.ot.hours += extVal; buckets.ot.pay += extVal * rate * 1.5; hasActiveShifts = true; } // Count Ext as active
          
          if ((startStr === 'OFF' || startStr === '') && isPH_Start) { 
              buckets.ph_available.hours += 8.0; 
              buckets.ph_available.pay += 8.0 * rate; 
              continue; 
          }
          if (startStr === 'OFF' || startStr === '') continue;
          
          if (startStr === 'SICK') { buckets.base.hours += STANDARD_HOURS; buckets.base.pay += STANDARD_HOURS * rate; continue; }
          
          // CARER CALCULATION
          if (startStr === 'CARER' || startStr === 'CARERS') { 
              carerHours += STANDARD_HOURS; 
              carerPay += STANDARD_HOURS * rate; 
              continue; 
          }

          if (startStr === 'PAID AL' || startStr === 'AL') { 
              if (dayIndex >= 1 && dayIndex <= 4) { buckets.base.hours += STANDARD_HOURS; buckets.base.pay += STANDARD_HOURS * rate; alLoadingPay += (STANDARD_HOURS * rate * 0.20); }
              continue; 
          }
          
          if (startStr === 'PHDO') { 
              buckets.ph_gazette.hours += STANDARD_HOURS; 
              buckets.ph_gazette.pay += STANDARD_HOURS * rate; 
              continue; 
          }
          
          const startMins = parseMinutes(startStr); 
          if (startMins !== null) {
            const midnight = 1440; 
            const endMins = startMins + SHIFT_DURATION_MINS;
            let hours1 = 0, hours2 = 0;
            if (endMins > midnight) { hours1 = (midnight - startMins) / 60; hours2 = (endMins - midnight) / 60; } 
            else { hours1 = STANDARD_HOURS; hours2 = 0; }
            
            const totalShiftLength = (hours1 + hours2) + extVal; 
            if (totalShiftLength > 11.5) {
                mealAllowanceCount++;
            }

            if (!isForceOT) {
                let isNight = false;
                if (endMins > 1440) {
                    isNight = true;
                    let shiftNightHours = 0;
                    if (dayIndex >= 1 && dayIndex <= 5 && !vicPublicHolidays[fullDate]) { shiftNightHours += hours1; }
                    if (hours2 > 0) {
                        let d2 = new Date(fullDate); d2.setDate(d2.getDate() + 1);
                        const d2Index = d2.getDay();
                        const d2Date = d2.toISOString().split('T')[0];
                        if (d2Index >= 1 && d2Index <= 5 && !vicPublicHolidays[d2Date]) { shiftNightHours += hours2; }
                    }
                    if (shiftNightHours > 0) { const roundedNight = Math.ceil(shiftNightHours); nightShiftHoursPaid += roundedNight; nightShiftPay += roundedNight * 7.90; }
                }
                if (!isNight && endMins > 1110) {
                    const isWeekday = (dayIndex >= 1 && dayIndex <= 5);
                    if (isWeekday && !vicPublicHolidays[fullDate]) { const totalHours = hours1 + hours2; const roundedHours = Math.ceil(totalHours); eveningShiftHoursPaid += roundedHours; eveningShiftPay += roundedHours * 4.17; }
                }
                if (!isNight && startMins < 360) {
                    const isWeekday = (dayIndex >= 1 && dayIndex <= 5);
                    if (isWeekday && !vicPublicHolidays[fullDate]) { const totalHours = hours1 + hours2; const roundedHours = Math.ceil(totalHours); earlyShiftHoursPaid += roundedHours; earlyShiftPay += roundedHours * 4.17; }
                }
            } 

            const rate1 = getMultiplierForDay(fullDate, dayIndex, isForceOT, isPTO);
            if(rate1.bank) bankedDays += (hours1/STANDARD_HOURS);
            if (rate1.bucket === 'base') { buckets.base.hours += hours1; buckets.base.pay += hours1 * rate * rate1.mult; }
            else if (rate1.bucket === 'ot') { buckets.ot.hours += hours1; buckets.ot.pay += hours1 * rate * rate1.mult; }
            else if (rate1.bucket === 'sat') { buckets.sat.hours += hours1; buckets.sat.pay += hours1 * rate * rate1.mult; }
            else if (rate1.bucket === 'sun') { buckets.sun.hours += hours1; buckets.sun.pay += hours1 * rate * rate1.mult; }
            else if (rate1.bucket === 'ph') { buckets.ph.hours += hours1; buckets.ph.pay += hours1 * rate * rate1.mult; }
            else if (rate1.bucket === 'ph_bank') { buckets.ph_bank.hours += hours1; buckets.ph_bank.pay += hours1 * rate * rate1.mult; } 
            
            if (hours2 > 0) {
                let d2 = new Date(fullDate); d2.setDate(d2.getDate() + 1);
                const nextIso = d2.toISOString().split('T')[0];
                const nextDayIndex = d2.getDay();
                const rate2 = getMultiplierForDay(nextIso, nextDayIndex, isForceOT, false);
                if (rate2.bucket === 'base') { buckets.base.hours += hours2; buckets.base.pay += hours2 * rate * rate2.mult; }
                else if (rate2.bucket === 'ot') { buckets.ot.hours += hours2; buckets.ot.pay += hours2 * rate * rate2.mult; }
                else if (rate2.bucket === 'sat') { buckets.sat.hours += hours2; buckets.sat.pay += hours2 * rate * rate2.mult; }
                else if (rate2.bucket === 'sun') { buckets.sun.hours += hours2; buckets.sun.pay += hours2 * rate * rate2.mult; }
                else if (rate2.bucket === 'ph') { buckets.ph.hours += hours2; buckets.ph.pay += hours2 * rate * rate2.mult; }
                else if (rate2.bucket === 'ph_bank') { buckets.ph_bank.hours += hours2; buckets.ph_bank.pay += hours2 * rate * rate2.mult; } 
            }
          }
        }
      }
      
      if (!hasActiveShifts && ojtCount === 0) {
          buckets = { 
              base: { hours: 0, pay: 0 }, ot: { hours: 0, pay: 0 }, sat: { hours: 0, pay: 0 }, 
              sun: { hours: 0, pay: 0 }, ph: { hours: 0, pay: 0 }, ph_bank: { hours: 0, pay: 0 },
              ph_gazette: { hours: 0, pay: 0 }, ph_available: { hours: 0, pay: 0 }
          };
          mealAllowanceCount = 0;
          carerPay = 0; 
          carerHours = 0;
      }

      const ojtPay = ojtCount * OJT_RATE;
      const mealAllowancePay = mealAllowanceCount * MEAL_ALLOWANCE_RATE;

      let totalGross = buckets.base.pay + buckets.ot.pay + buckets.sat.pay + buckets.sun.pay + buckets.ph.pay + buckets.ph_bank.pay + buckets.ph_gazette.pay + buckets.ph_available.pay + earlyShiftPay + eveningShiftPay + nightShiftPay + alLoadingPay + ojtPay + mealAllowancePay + carerPay;
      
      let taxableFortnight = totalGross - lease - superSac; 

      if(taxableFortnight < 0) taxableFortnight = 0;
      
      const annualTaxable = taxableFortnight * 26;
      let annualTax = 0;
      if (claimThreshold) {
        if (annualTaxable > 18200 && annualTaxable <= 45000) annualTax = (annualTaxable - 18200) * 0.16;
        else if (annualTaxable <= 135000) annualTax = 4288 + (annualTaxable - 45000) * 0.30;
        else if (annualTaxable <= 190000) annualTax = 31288 + (annualTaxable - 135000) * 0.37;
        else if (annualTaxable > 190000) annualTax = 51638 + (annualTaxable - 190000) * 0.45;
      } else {
        if (annualTaxable <= 45000) annualTax = annualTaxable * 0.16;
        else if (annualTaxable <= 135000) annualTax = 7200 + (annualTaxable - 45000) * 0.30;
        else if (annualTaxable <= 190000) annualTax = 34200 + (annualTaxable - 135000) * 0.37;
        else annualTax = 54550 + (annualTaxable - 190000) * 0.45;
      }
      let annualMedicare = 0;
      if (annualTaxable > 27222) { if (annualTaxable <= 34027) annualMedicare = (annualTaxable - 27222) * 0.10; else annualMedicare = annualTaxable * 0.02; }
      
      const annualGross = totalGross * 26;
      let annualHecs = 0; if (hasHecs) { annualHecs = annualGross * getHecsRate(annualGross); }

      const rawPayg = (annualTax + annualMedicare) / 26;
      const paygFortnight = Math.ceil(rawPayg / 5) * 5;
      const hecsFortnight = annualHecs / 26;
      const superFortnight = totalGross * 0.12; 
      const netFortnight = taxableFortnight - paygFortnight - hecsFortnight - postTaxOther - postTaxSuper;

      document.getElementById('hrs-base').innerText = buckets.base.hours.toFixed(4);
      document.getElementById('rate-base').innerText = rate.toFixed(4);
      document.getElementById('out-base').innerText = buckets.base.pay.toFixed(2);
      document.getElementById('hrs-ot').innerText = buckets.ot.hours.toFixed(4);
      document.getElementById('rate-ot').innerText = (rate * 1.5).toFixed(4);
      document.getElementById('out-ot').innerText = buckets.ot.pay.toFixed(2);
      document.getElementById('hrs-sat').innerText = buckets.sat.hours.toFixed(4);
      document.getElementById('rate-sat').innerText = "1.5 / 2.0"; 
      document.getElementById('out-sat').innerText = buckets.sat.pay.toFixed(2);
      document.getElementById('hrs-sun').innerText = buckets.sun.hours.toFixed(4);
      document.getElementById('rate-sun').innerText = (rate * 2.0).toFixed(4);
      document.getElementById('out-sun').innerText = buckets.sun.pay.toFixed(2);
      document.getElementById('hrs-ph').innerText = buckets.ph.hours.toFixed(4);
      document.getElementById('rate-ph').innerText = (rate * 2.5).toFixed(4);
      document.getElementById('out-ph').innerText = buckets.ph.pay.toFixed(2);
      document.getElementById('hrs-ph-bank').innerText = buckets.ph_bank.hours.toFixed(4);
      document.getElementById('rate-ph-bank').innerText = (rate * 1.5).toFixed(4);
      document.getElementById('out-ph-bank').innerText = buckets.ph_bank.pay.toFixed(2);
      
      document.getElementById('hrs-ph-gazette').innerText = buckets.ph_gazette.hours.toFixed(4);
      document.getElementById('rate-ph-gazette').innerText = rate.toFixed(4);
      document.getElementById('out-ph-gazette').innerText = buckets.ph_gazette.pay.toFixed(2);

      // OUTPUT PH AVAILABLE
      document.getElementById('hrs-ph-avail').innerText = buckets.ph_available.hours.toFixed(4);
      document.getElementById('rate-ph-avail').innerText = rate.toFixed(4);
      document.getElementById('out-ph-avail').innerText = buckets.ph_available.pay.toFixed(2);

      // OUTPUT CARER
      document.getElementById('hrs-carer').innerText = carerHours.toFixed(4);
      document.getElementById('rate-carer').innerText = rate.toFixed(4);
      document.getElementById('out-carer').innerText = carerPay.toFixed(2);

      document.getElementById('out-al-load').innerText = alLoadingPay.toFixed(2);

      document.getElementById('cnt-ojt').innerText = ojtCount.toFixed(4);
      document.getElementById('rate-ojt').innerText = OJT_RATE.toFixed(2); 
      document.getElementById('out-ojt').innerText = ojtPay.toFixed(2);
      
      document.getElementById('cnt-meal').innerText = mealAllowanceCount.toFixed(4);
      document.getElementById('out-meal').innerText = mealAllowancePay.toFixed(2);

      document.getElementById('hrs-early').innerText = earlyShiftHoursPaid.toFixed(4);
      document.getElementById('out-early').innerText = earlyShiftPay.toFixed(2);
      document.getElementById('hrs-evening').innerText = eveningShiftHoursPaid.toFixed(4);
      document.getElementById('out-evening').innerText = eveningShiftPay.toFixed(2);
      document.getElementById('hrs-night').innerText = nightShiftHoursPaid.toFixed(4);
      document.getElementById('out-night').innerText = nightShiftPay.toFixed(2);

      document.getElementById('r-lease').innerText = lease.toFixed(2);
      document.getElementById('r-superSac').innerText = superSac.toFixed(2);
      document.getElementById('r-otherPost').innerText = postTaxOther.toFixed(2);
      document.getElementById('r-superPost').innerText = postTaxSuper.toFixed(2);
      document.getElementById('r-banked').innerText = bankedDays.toFixed(1);

      document.getElementById('r-gross').innerText = totalGross.toFixed(2);
      document.getElementById('r-taxable').innerText = taxableFortnight.toFixed(2);
      document.getElementById('r-tax').innerText = paygFortnight.toFixed(2);
      document.getElementById('r-hecs').innerText = hecsFortnight.toFixed(2);
      document.getElementById('r-super').innerText = superFortnight.toFixed(2);
      document.getElementById('r-net').innerText = netFortnight.toFixed(2);
      
      const startVal = document.getElementById('startDate').value;
      if(startVal) {
          const d = new Date(startVal);
          d.setDate(d.getDate() + 13); 
          document.getElementById('display-pay-period').innerText = "Period Ending: " + d.toLocaleDateString('en-AU');
      }

      const toggleRow = (id, val) => { const el = document.getElementById(id); if(el) el.style.display = (val > 0.001) ? 'table-row' : 'none'; };
      toggleRow('row-base', buckets.base.pay);
      toggleRow('row-ot', buckets.ot.pay);
      toggleRow('row-sat', buckets.sat.pay);
      toggleRow('row-sun', buckets.sun.pay);
      toggleRow('row-ph', buckets.ph.pay);
      toggleRow('row-ph-bank', buckets.ph_bank.pay);
      toggleRow('row-ph-gazette', buckets.ph_gazette.pay); 
      toggleRow('row-ph-avail', buckets.ph_available.pay); // NEW TOGGLE
      toggleRow('row-carer', carerPay); 
      toggleRow('row-al-load', alLoadingPay);
      
      toggleRow('row-ojt', ojtPay);
      toggleRow('row-meal', mealAllowancePay);
      toggleRow('row-early', earlyShiftPay);
      toggleRow('row-evening', eveningShiftPay);
      toggleRow('row-night', nightShiftPay);

      toggleRow('row-lease', lease);
      toggleRow('row-superSac', superSac);
      toggleRow('row-otherPost', postTaxOther);
      toggleRow('row-superPost', postTaxSuper);
      toggleRow('row-banked', bankedDays);

      document.getElementById('results').style.display = 'block';
      
      // Comparison Trigger
      if (importedPayslipData) {
          renderVarianceReport({
              gross: totalGross,
              net: netFortnight,
              tax: paygFortnight,
              elements: buckets,
              ojt: ojtCount,
              carerHours: carerHours // <--- PASSED CARER HOURS
          });
      }

  } catch(e) {
      console.error(e);
      alert("Calculation Error: " + e.message);
  }
}

function updateYTD() {
    const ytdVal = parseFloat(document.getElementById('ytdInput').value) || 0;
    const dateVal = document.getElementById('ytdDate').value;
    let payslipDate = new Date();
    if (dateVal) { payslipDate = new Date(dateVal); }
    const currentYear = payslipDate.getFullYear();
    const currentMonth = payslipDate.getMonth(); 
    let fyStartYear = currentYear;
    if (currentMonth < 6) { fyStartYear = currentYear - 1; }
    const fyStartDate = new Date(fyStartYear, 6, 1); 
    const fyEndDate = new Date(fyStartYear + 1, 5, 30); 
    const msPerDay = 1000 * 60 * 60 * 24;
    const diffTimePast = payslipDate - fyStartDate;
    const diffDaysPast = Math.max(0, Math.ceil(diffTimePast / msPerDay));
    const fortnightsPast = Math.max(1, diffDaysPast / 14); 
    const diffTimeFuture = fyEndDate - payslipDate;
    const diffDaysFuture = Math.max(0, Math.ceil(diffTimeFuture / msPerDay));
    const fortnightsRemaining = diffDaysFuture / 14; 
    let avgPay = 0;
    if(fortnightsPast > 0) { avgPay = ytdVal / fortnightsPast; }
    const projectedTotal = ytdVal + (avgPay * fortnightsRemaining);
    document.getElementById('ytd-avg-pay').innerText = '$' + avgPay.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById('ytd-pays-left').innerText = fortnightsRemaining.toFixed(1);
    document.getElementById('ytd-projected-total').innerText = '$' + projectedTotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function renderVarianceReport(calcData) {
    const tbody = document.getElementById('variance-body');
    tbody.innerHTML = '';
    
    const ps = importedPayslipData;
    
    const addRow = (label, calcVal, psVal, isCurr=true) => {
        const diff = calcVal - psVal;
        const isMatch = Math.abs(diff) < 0.05;
        const prefix = isCurr ? '$' : '';
        const displayCalc = prefix + calcVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const displayPs = prefix + psVal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const displayDiff = prefix + diff.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        const row = `<tr>
            <td>${label}</td>
            <td>${displayCalc}</td>
            <td>${displayPs}</td>
            <td class="${isMatch ? 'var-match' : 'var-diff'}">${isMatch ? '‚úì Match' : displayDiff}</td>
        </tr>`;
        tbody.innerHTML += row;
    };
    
    addRow('Gross Pay', calcData.gross, ps.gross);
    addRow('PAYG Tax', calcData.tax, ps.tax);
    addRow('Net Pay', calcData.net, ps.net);
    
    const psNormal = (ps.elements["Normal"] && ps.elements["Normal"].units) ? ps.elements["Normal"].units : 0;
    const calcNormal = calcData.elements.base.hours; // Removed ph_gazette from here
    if (psNormal > 0 || calcNormal > 0) addRow('Normal Hours', calcNormal, psNormal, false);
    
    let psSat = 0;
    for(let k in ps.elements) if (k.includes("TI+50%")) psSat += ps.elements[k].units;
    if (psSat > 0 || calcData.elements.sat.hours > 0) addRow('Saturday Hours', calcData.elements.sat.hours, psSat, false);

    let psSun = 0;
    for(let k in ps.elements) if (k.includes("TI+100%")) psSun += ps.elements[k].units;
    if (psSun > 0 || calcData.elements.sun.hours > 0) addRow('Sunday Hours', calcData.elements.sun.hours, psSun, false);

    let psOjt = 0;
    for(let k in ps.elements) if (k.includes("OJT")) psOjt += ps.elements[k].units;
    if (psOjt > 0 || calcData.ojt > 0) addRow('OJT Count', calcData.ojt, psOjt, false);
    
    // NEW: Carer's Leave Logic
    let psCarer = 0;
    for(let k in ps.elements) {
        const lowerK = k.toLowerCase();
        // Aggregates anything resembling Carer, Personal, Sick, or "cares lve"
        if (lowerK.includes("carer") || lowerK.includes("personal") || lowerK.includes("sick") || lowerK.includes("cares lve")) {
            psCarer += ps.elements[k].units;
        }
    }
    if (psCarer > 0 || (calcData.carerHours && calcData.carerHours > 0)) {
        addRow("Carer's/Personal Lve", calcData.carerHours || 0, psCarer, false);
    }

    // NEW PH Gazette Logic
    let psGazette = 0;
    for(let k in ps.elements) {
        if (k.toLowerCase().includes("gazette")) psGazette += ps.elements[k].units;
    }
    if (psGazette > 0 || calcData.elements.ph_gazette.hours > 0) {
        addRow('PH Gazette', calcData.elements.ph_gazette.hours, psGazette, false);
    }

    // NEW: PH Available Logic
    let psPhAvail = 0;
    for(let k in ps.elements) {
        if (k.toLowerCase().includes("ph available")) {
            psPhAvail += ps.elements[k].units;
        }
    }
    // Only show if either calculation or payslip has value
    if (psPhAvail > 0 || calcData.elements.ph_available.hours > 0) {
        addRow('PH Available', calcData.elements.ph_available.hours, psPhAvail, false);
    }
    
    document.getElementById('variance-report').style.display = 'block';
}

function bangHoliday(element) {
  if (!element.checked) return;
  const emojis = ['üç∏', 'üï∂Ô∏è', 'üèùÔ∏è'];
  const rect = element.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2 + window.scrollX;
  const centerY = rect.top + rect.height / 2 + window.scrollY;
  for (let i = 0; i < 15; i++) {
    const el = document.createElement('div');
    el.classList.add('emoji-particle');
    el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
    document.body.appendChild(el);
    el.style.left = centerX + 'px'; 
    el.style.top = centerY + 'px';
    const tx = (Math.random() - 0.5) * 200; 
    const ty = -80 - (Math.random() - 0.5) * 150; 
    const rot = (Math.random() - 0.5) * 360;
    el.style.setProperty('--tx', `${tx}px`); 
    el.style.setProperty('--ty', `${ty}px`);
    el.style.setProperty('--rot', `${rot}deg`);
    setTimeout(() => el.remove(), 1000);
  }
}
</script>
</body>
</html>
